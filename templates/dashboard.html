<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%232a2f45"/%3E%3Ctext x="50" y="60" font-size="50" text-anchor="middle" fill="%23fff" font-family="Arial, Helvetica, sans-serif"%3EA%3C/text%3E%3C/svg%3E'>

  <title>Dashboard de Análise Estratégica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>

  <style>
    body {
      padding: 20px;
      background-color: #f8fafc;
      font-family: "Segoe UI", sans-serif;
    }
    h2 {
      margin-bottom: 25px;
      color: #2a2f45;
      font-weight: 600;
    }
    .chart-card {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 25px;
    }
    #pareto, #matrix {
      width: 100% !important;
      height: 420px !important;
      display: block !important;
    }
    .table {
      margin-top: 10px;
    }
    pre.trace {
      background-color: #111;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      max-height: 300px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Dashboard de Análise Estratégica</h2>

    <div class="chart-card">
      <h5>1. Análise ABC (Pareto)</h5>
      <div id="pareto"></div>
      <div id="pareto-fallback" class="text-muted small"></div>
    </div>


    <div class="card p-3 mb-3">
      <h6>Classificação das Categorias</h6>
      <div id="table-area">
        {{ tabela_html | safe }}
      </div>
    </div>


    <div class="chart-card">
      <h5>2. Matriz de Desempenho (Giro, Vendas, Margem)</h5>
      <div id="matrix"></div>
      <div id="matrix-fallback" class="text-muted small"></div>
    </div>


    {% if error_info %}
    <div class="card border-danger mb-3">
      <div class="card-body">
        <h5 class="card-title text-danger">Erro ao gerar dashboard</h5>
        <p><strong>Mensagem:</strong> {{ error_info.error_message }}</p>
        <p><strong>Traceback:</strong></p>
        <pre class="trace">{{ error_info.traceback }}</pre>
      </div>
    </div>
    {% endif %}

    {% if df_info %}
    <div class="card mb-3">
      <div class="card-body">
        <h6>Info do DataFrame (debug)</h6>
        <p><strong>Colunas:</strong> {{ df_info.columns }}</p>
        <p><strong>Tipos:</strong> {{ df_info.dtypes }}</p>
        <p><strong>Primeiras linhas (até 10):</strong></p>
        <pre>{{ df_info.head | tojson(indent=2) }}</pre>
      </div>
    </div>
    {% endif %}
  </div>

 
    <script>
      const paretoObj = {{ pareto_obj | default(None) | tojson }};
      const matrixObj = {{ matrix_obj | default(None) | tojson }};

      function renderPlotlyFromObj(id, plotObj, defaultHeight = 420) {
        const el = document.getElementById(id);
        const fallback = document.getElementById(id + '-fallback');
        if (!el) return;

        try {
          if (!plotObj) {
            fallback.innerText = 'Gráfico indisponível (erro ao gerar).';
            return;
          }

          plotObj.layout = plotObj.layout || {};
          plotObj.layout.autosize = true;
          plotObj.layout.margin = plotObj.layout.margin || { l: 60, r: 60, t: 60, b: 60 };
          plotObj.layout.width = el.clientWidth || window.innerWidth * 0.9;
          plotObj.layout.height = defaultHeight;

          el.style.width = '100%';
          el.style.display = 'block';

          Plotly.newPlot(id, plotObj.data, plotObj.layout, { responsive: true });
          window.addEventListener('resize', () => Plotly.Plots.resize(el));
          fallback.innerText = '';
        } catch (err) {
          console.error('Erro ao renderizar', id, err);
          fallback.innerText = 'Erro ao renderizar gráfico.';
        }
      }
 
      renderPlotlyFromObj('pareto', paretoObj, 420);
      renderPlotlyFromObj('matrix', matrixObj, 420);
    </script>

</body>
</html>
set FLASK_APP=app.py